# this was created with help of copilot which should be obvious with all the inline scripts. this is just test. nothing imporatnt here
# and we made this a mess on purpose to test drift detection.
name: Drift Detection

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  issues: write

env:
  RESOURCE_GROUP: rg-messydrift-test

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Pull DriftGuard Docker image
        run: docker pull mwhooo/driftguard:latest
      
      - name: Run drift detection on all resources
        id: drift-check
        continue-on-error: true
        run: |
          set +e  # Don't exit on error
          
          # Copy Azure credentials for container
          mkdir -p $HOME/.azure-container
          cp -r $HOME/.azure/* $HOME/.azure-container/
          
          # Create reports directory
          mkdir -p drift-reports
          
          DRIFT_DETECTED=0
          
          # Define resources to check
          declare -a RESOURCES=(
            "Storage Account|storage.bicep|temp/params/storage-params.json"
            "Network Security Group|configs/nsg-config.bicepparam|"
            "Key Vault|random/stuff/kv.bicepparam|"
            "Virtual Network|old_stuff/network/vnet.bicep|parameters.json"
            "Container Registry|ContainerRegistry.bicep|p/acr-prod.bicepparam"
            "Web App|webapp/app.bicep|webapp/dev-params.bicepparam"
          )
          
          # Check each resource sequentially
          for resource in "${RESOURCES[@]}"; do
            IFS='|' read -r name template params <<< "$resource"
            
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üîç Checking: $name"
            echo "   Template: $template"
            [ -n "$params" ] && echo "   Parameters: $params"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            # Sanitize filename
            SAFE_NAME=$(echo "$name" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
            
            # Build Docker command
            DRIFT_CMD="docker run --rm \
              -v $HOME/.azure-container:/root/.azure \
              -v $(pwd):/workspace \
              mwhooo/driftguard:latest \
              --bicep-file /workspace/$template \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --output Json"
            
            # Add parameters if specified
            [ -n "$params" ] && DRIFT_CMD="$DRIFT_CMD --parameters-file /workspace/$params"
            
            # Run and capture output (stderr and stdout separately)
            $DRIFT_CMD > "drift-reports/${SAFE_NAME}-raw.json" 2>&1 || true
            
            # Extract only the JSON portion (between first { and last })
            sed -n '/{/,/}/p' "drift-reports/${SAFE_NAME}-raw.json" | grep -v '^üîç\|^üìÑ\|^üìã\|^üéØ\|^üèóÔ∏è\|^üìä\|^üîá\|^‚ö†Ô∏è\|^‚úÖ\|^üì¶\|^‚ùå\|^üí°' > "drift-reports/${SAFE_NAME}.json" 2>/dev/null || true
            
            # Also get console output
            docker run --rm \
              -v $HOME/.azure-container:/root/.azure \
              -v $(pwd):/workspace \
              mwhooo/driftguard:latest \
              --bicep-file /workspace/$template \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --output Console \
              $([ -n "$params" ] && echo "--parameters-file /workspace/$params") \
              > "drift-reports/${SAFE_NAME}.txt" 2>&1 || true
            
            # Check drift using correct JSON structure
            if [ -f "drift-reports/${SAFE_NAME}.json" ]; then
              HAS_DRIFT=$(jq -r '.HasDrift // false' "drift-reports/${SAFE_NAME}.json" 2>/dev/null || echo "false")
              
              if [ "$HAS_DRIFT" = "true" ]; then
                RESOURCE_COUNT=$(jq -r '.ResourceDrifts | length' "drift-reports/${SAFE_NAME}.json" 2>/dev/null || echo "0")
                echo "‚ùå Drift detected: $RESOURCE_COUNT resource(s)"
                DRIFT_DETECTED=1
              else
                echo "‚úÖ No drift detected"
              fi
            else
              echo "‚ö†Ô∏è Could not analyze drift"
            fi
            
            # Small delay between checks to avoid rate limits
            sleep 2
          done
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "drift-detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT
          
          if [ "$DRIFT_DETECTED" -eq 1 ]; then
            echo "‚ùå Configuration drift detected!"
            exit 1
          else
            echo "‚úÖ All resources in sync"
          fi
      
      - name: Upload drift reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drift-reports
          path: drift-reports/
          retention-days: 30

  create-issue:
    runs-on: ubuntu-latest
    needs: detect-drift
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download drift reports
        uses: actions/download-artifact@v4
        with:
          name: drift-reports
          path: drift-reports
      
      - name: Combine drift reports
        id: combine-reports
        run: |
          echo "## üö® Configuration Drift Detected" > issue-body.md
          echo "" >> issue-body.md
          echo "**Detection Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> issue-body.md
          echo "**Resource Group:** ${{ env.RESOURCE_GROUP }}" >> issue-body.md
          echo "**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> issue-body.md
          echo "" >> issue-body.md
          echo "### üìä Drift Summary" >> issue-body.md
          echo "" >> issue-body.md
          
          # Process each drift report JSON file
          for json_file in drift-reports/*.json; do
            # Skip raw files
            [[ "$json_file" == *"-raw.json" ]] && continue
            
            if [ -f "$json_file" ]; then
              resource_name=$(basename "$json_file" .json | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
              txt_file="${json_file%.json}.txt"
              
              # Parse JSON for drift using correct structure
              HAS_DRIFT=$(jq -r '.HasDrift // false' "$json_file" 2>/dev/null || echo "false")
              
              if [ "$HAS_DRIFT" = "true" ]; then
                echo "#### ‚ö†Ô∏è $resource_name" >> issue-body.md
                echo "" >> issue-body.md
                
                # Extract summary from JSON using correct structure
                DRIFT_COUNT=$(jq -r '.ResourceDrifts | length' "$json_file" 2>/dev/null || echo "0")
                DETECTED_AT=$(jq -r '.DetectedAt // "N/A"' "$json_file" 2>/dev/null || echo "N/A")
                echo "- **Total Resources with Drift:** $DRIFT_COUNT" >> issue-body.md
                echo "- **Detection Time:** $DETECTED_AT" >> issue-body.md
                echo "" >> issue-body.md
                
                # List drifted resources using correct structure
                echo "**Drifted Resources:**" >> issue-body.md
                jq -r '.ResourceDrifts[]? | "- `\(.ResourceType)` **\(.ResourceName)**\n  - Properties changed: \(.PropertyDrifts | length)"' "$json_file" >> issue-body.md 2>/dev/null || true
                echo "" >> issue-body.md
                
                # Add detailed drift information
                echo "<details>" >> issue-body.md
                echo "<summary>üìã Detailed Drift Analysis (Click to expand)</summary>" >> issue-body.md
                echo "" >> issue-body.md
                echo '```json' >> issue-body.md
                jq '.' "$json_file" 2>/dev/null || cat "$json_file"
                echo '```' >> issue-body.md
                echo "</details>" >> issue-body.md
                echo "" >> issue-body.md
                
                # Add console output if exists
                if [ -f "$txt_file" ]; then
                  echo "<details>" >> issue-body.md
                  echo "<summary>üìù Console Output (Click to expand)</summary>" >> issue-body.md
                  echo "" >> issue-body.md
                  echo '```' >> issue-body.md
                  head -200 "$txt_file" >> issue-body.md
                  echo '```' >> issue-body.md
                  echo "</details>" >> issue-body.md
                  echo "" >> issue-body.md
                fi
              fi
            fi
          done
          
          echo "### üîß Remediation Steps" >> issue-body.md
          echo "" >> issue-body.md
          echo "1. Review the drift details above" >> issue-body.md
          echo "2. Determine if changes are intentional or unauthorized" >> issue-body.md
          echo "3. Update Bicep templates if changes should be permanent" >> issue-body.md
          echo "4. OR re-deploy to restore expected configuration:" >> issue-body.md
          echo '   ```bash' >> issue-body.md
          echo '   gh workflow run full-stack-deploy.yml' >> issue-body.md
          echo '   ```' >> issue-body.md
          echo "5. Close this issue once drift is resolved" >> issue-body.md
          echo "" >> issue-body.md
          echo "### üì¶ Artifacts" >> issue-body.md
          echo "" >> issue-body.md
          echo "Full JSON reports available in workflow artifacts:" >> issue-body.md
          echo "- [Download All Drift Reports](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> issue-body.md
          echo "" >> issue-body.md
          echo "---" >> issue-body.md
          echo "_Automated drift detection via [DriftGuard](https://github.com/mwhooo/DriftGuard)_" >> issue-body.md
      
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueBody = fs.readFileSync('issue-body.md', 'utf8');
            
            // Check if there's already an open drift issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detected'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## üîÑ New Drift Detection\n\n${issueBody}`
              });
              console.log(`Updated existing issue #${issue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® Configuration Drift Detected - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['drift-detected', 'automated', 'infrastructure']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }
